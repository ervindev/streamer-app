<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
			   xmlns:s="library://ns.adobe.com/flex/spark"
			   width="800" height="600"
			   frameRate="30"
               backgroundAlpha="0"
               initialize="onInitialize()"
			   addedToStage="onAddedToStage()"
               creationComplete="onCreationComplete()"
>
    <fx:Script><![CDATA[
        import com.streamer.app.player.RTMPPlayer;
        import com.streamer.app.publisher.RTMPCamera;
        import com.streamer.app.common.RTMPErrorCode;
        import com.streamer.app.common.event.RTMPMediaEvent;

        import mx.core.FlexGlobals;

        private static const INTRO_STATE:String = "introState";
        private static const PLAYBACK_STATE:String = "playbackState";
        private static const ERROR_STATE:String = "errorState";

        private var _streamURL:String = "rtmp://192.168.0.105/myapp/";
        private var _streamName:String = "mystream";

        private var _player:RTMPPlayer;
        private var _camera:RTMPCamera;

        [Bindable]
        private var _errorCode:String;

        private function onInitialize():void
        {
            checkFlashVars();
        }

        private function onCreationComplete():void
        {

        }

        private function onAddedToStage():void
        {

        }

        private function createCamera():void
        {
            _camera = new RTMPCamera();
            _camera.addEventListener(RTMPMediaEvent.STARTED, cameraStartedHandler);
            _camera.addEventListener(RTMPMediaEvent.ERROR, cameraErrorHandler);
        }

        private function startCamera():void
        {
            if (_camera == null)
            {
                createCamera();
            }
            _camera.connect(_streamURL, _streamName);
        }

        private function cameraStartedHandler(event:RTMPMediaEvent):void
        {
            startPlayer();
        }

        private function cameraErrorHandler(event:RTMPMediaEvent):void
        {
            _errorCode = event.code;

            switch (event.code)
            {
                case RTMPErrorCode.CAMERA_MUTED:
                    changeState(ERROR_STATE);
                    Security.showSettings(SecurityPanel.PRIVACY);
                    break;
                default:
                    changeState(ERROR_STATE);
            }
        }

        private function startPlayer():void
        {
            _player = new RTMPPlayer();
            _player.connect(_streamURL, _streamName);
            stage.addChild(_player);

            changeState(PLAYBACK_STATE);
        }

        private function changeState(stateName:String):void
        {
            currentState = stateName;
        }

        private function onTryAgainClick():void
        {
            changeState(INTRO_STATE);
        }

        private function onEnterIntroState():void
        {
            startCamera();
        }

        private function checkFlashVars():void
        {
            var parameters:Object = FlexGlobals.topLevelApplication.parameters;
            if (parameters.hasOwnProperty("streamURL"))
            {
                _streamURL = parameters.streamURL;
            }
            if (parameters.hasOwnProperty("streamName"))
            {
                _streamName = parameters.streamName;
            }
        }
        ]]></fx:Script>

    <s:states>
        <s:State name="introState" enterState="onEnterIntroState()"/>
        <s:State name="playbackState"/>
        <s:State name="errorState"/>
    </s:states>
    <s:VGroup width="100%" height="100%">
        <s:Group id="introGroup" includeIn="introState">
            <s:Label text="Initializing camera and mic..."/>
        </s:Group>

        <s:Group id="playbackGroup" includeIn="playbackState">
        </s:Group>

        <s:VGroup id="errorGroup" includeIn="errorState" width="100%" height="100%"
                  verticalAlign="middle"
                  horizontalAlign="center">
            <s:Label text="Oops, something went wrong!"/>
            <s:Label text="Error code: {_errorCode}"/>
            <s:Button id="tryAgainButton" label="Try Again" click="onTryAgainClick()"/>
        </s:VGroup>
    </s:VGroup>

    <!--<s:SpriteVisualElement id="spriteVisualElement" width="100%" height="100%"/>-->
</s:Application>